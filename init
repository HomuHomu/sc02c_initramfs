#!/sbin/busybox sh

PATH_=$PATH
export PATH=/sbin

# extract initramfs
/busybox lzcat mbs.tar.lzma | /busybox tar xf -
/busybox lzcat sbin.tar.lzma | /busybox tar xf -
/busybox lzcat vendor.tar.lzma | /busybox tar xf -
/busybox lzcat res.tar.lzma | /busybox tar xf -
/busybox mv /recovery /sbin/
rm /busybox

# extract block device files
tar xf /misc/dev.tar

mount -t proc proc /proc
#BUILD_TARGET=`cat /proc/sys/kernel/build_target`
BUILD_TARGET=2
RECOVERY_MODE=`grep -c bootmode=2 /proc/cmdline`
umount /proc

if [ "$RECOVERY_MODE" = '1' ]; then
  # recovery mode
  sh /mbs/init.recovery.sh $BUILD_TARGET
else
  # normal mode
  sh /mbs/init.normal.sh $BUILD_TARGET
fi

# cleanup
rm -fr /dev/* /misc/dev.tar
# init start
mv /_init /init

export PATH=$PATH_
exec /init

