#!/sbin/busybox sh

# setup env
export DEV_BLOCK_ZIMAGE=/dev/block/mmcblk0p5
export DEV_BLOCK_RECOVERY=/dev/block/mmcblk0p6
export DEV_BLOCK_CACHE=/dev/block/mmcblk0p7
export DEV_BLOCK_FACTORYFS=/dev/block/mmcblk0p9
export DEV_BLOCK_DATA=/dev/block/mmcblk0p10
export DEV_BLOCK_SDCARD=/dev/block/mmcblk0p11
export DEV_BLOCK_HIDDEN=/dev/block/mmcblk0p12
export DEV_BLOCK_EMMC1=/dev/block/mmcblk1p1
export DEV_BLOCK_EMMC2=/dev/block/mmcblk1p2
export DEV_BLOCK_EMMC3=/dev/block/mmcblk1p3

export MBS_LOG=/xdata/mbs4.log
export MBS_CONF="/xdata/mbs.conf"
export ERR_MSG="/xdata/mbs.err"


PATH_=$PATH
export PATH=/sbin

# extract block device files
tar xf /misc/dev.tar

# extract initramfs
lzcat mbs.tar.lzma | tar xf -
lzcat vendor.tar.lzma | tar xf -
lzcat res.tar.lzma | tar xf -
lzcat compress.tar.lzma | tar xf -

mv /compress/nandroid-md5.sh /sbin/
mv /compress/bootanimation.sh /sbin/
mv /compress/bootanimation /sbin/
mv /compress/killrecovery.sh /sbin/
mv /compress/fota.png /sbin/
mv /compress/fix_permissions /sbin/
mv /compress/sdparted /sbin/
mv /compress/fat.format /sbin/
mv /compress/adbd /sbin/
mv /compress/tune2fs /sbin/
mv /compress/parted /sbin/
mv /compress/e2fsck /sbin/
mv /compress/sreadaheadd /sbin/

mount -t proc proc /proc
#BUILD_TARGET=`cat /proc/sys/kernel/build_target`
BUILD_TARGET=2
RECOVERY_MODE=`grep -c bootmode=2 /proc/cmdline`
umount /proc

mount -t ext4 $DEV_BLOCK_DATA /xdata

if [ "$RECOVERY_MODE" = '1' ]; then
  # recovery mode
  sh /mbs/init.recovery.sh $BUILD_TARGET
else
  # normal mode
  sh /mbs/init.normal.sh $BUILD_TARGET
fi

umount /xdata

# cleanup
rm -rf /dev/* /misc/dev.tar
rm -rf /compress
rm /*.tar.lzma

# init start
mv /_init /init

export PATH=$PATH_
exec /init

